[toc]

# 第二章、应用层

网络计算机网络存在的理由。我们会讨论：

* 应用层的主要概念，包括应用层所需要的网络服务、客户机与服务器、进程与运输层接口。
* 几种网络层应用，包括Web、电子邮件、DNS、对等文件分发和P2P因特网电话。
* 开发运行在TCP和UDP上的网络应用程序的方法，特别是套接字API（程序应用界面）。

## 2.1 应用层协议原理

研发网络应用程序的核心是写出能够运行在不同端系统和通过网络彼此通信的程序。

而网络核心设备（路由器、链路交换机）在应用层不起作用。

### 2.1.1 网络应用程序体系结构

从应用程序开发者的角度，网络的体系结构是固定的，并为应用程序提供了特定的服务集合。应用程序体系结构（**区别于网络的体系结构**）由应用程序研发者设计，规定了如何在各种端系统上组织该应用程序。

**现代网络中应用程序所使用的两种主流的体系结构分别是客户机/服务器模型和对等体系结构（P2P)**

#### 客户机/服务器模型

1. 客户机/服务器体系结构中，有一个总是打开的作主机称为服务器，服务于来自许多其他的称为客户机的主机的请求。 Web、FTP、Telnet（远程终端协议，实现远程登录）和电子邮件采用的就是典型的客户机/服务器模型。
  
2. 我们可以注意到，客户机之间不直接通信。

3. 客户机/服务器模型的一个重要特征是服务器具有固定的，周知的地址，称为IP地址。所以客户机总是能够通过该地址向服务器发送分组请求以与其联系。

4. 在这个模型中，有时候会出现一台服务器主机跟不上其所有客户机请求的情况。为此，在C/S体系结构中常用主机集群（服务器场Server Farm）来创建强大的虚拟服务器。

5. 基于这种体系结构的应用通常是**基础设施密集**的，因为他们需要向服务提供商购买，安装和维护服务器场。为此服务提供商需支付为了发送和接收来自互联网的数据而不断出现的互联和宽带费用。

#### P2P体系结构

1. 在这种体系结构下对基础设施服务器有着最小的依赖。任意连接的主机对直接相互通信。

2. P2P体系结构应用于流量密集型的应用程序，如文件分发、文件搜索/共享、因特网电话（Skype）和IPTV（交互式网络电视）。

3. P2P体系结构具有自扩展性，成本有效的，有着高度分布和开发性质，故需要关注其安全性。

### 2.1.2 进程通信

不同端系统的进程通过跨越计算机网络交换报文而相互通信。发送进程创建并向网络中发送报文，接收进程接受这些报文并可能负责回送报文。

1. 客户机与服务器进程：对于每对通信进程，我们通常将这两个进程之一表示为客户机（Client），而另一个标记为服务器（Server）。而在P2P应用中，一个进程可以即是客户端又是服务器。

2. **不论是C/S还是P2P，我们总能标记处一个进程为客户机、一个进程为服务器**，具体方法为：**发起通信的进程被标识为客户机**，**在会话开始前等待联系的是服务器。**
   
3. 进程通过一个叫套接字（Socket）的软件接口在网络上发送和接收报文。我们也将套接字称为应用程序与网络之间的应用程序编程接口（API）。一旦应用程序选择了一个运输层协议，则应用程序就建立在由该协议提供的传输层服务之上。

### 2.1.3 可供应用程序使用的运输服务

**选择合适的传输层协议：**

**考虑因素主要包括：可靠数据传输，吞吐量，定时和安全性。**

1. 可靠数据传输，一些多媒体应用，如实时音频等能够承受一定程度的数据丢失。

2. 吞吐量是发送进程能够向接收进程交付比特的速率，而吞吐量由于多会话共享宽带的原因产生吞吐量随之间波动。吞吐量的服务专指应用程序可以请求确保的吞吐量保证。对宽带敏感的应用对吞吐量有特殊需求，而弹性应用能够根据需要充分利用可供使用的吞吐量。
   
3. 定时，多种形式：如设置传输延时限制。网络电话、多方游戏等对此更强调。

4. 安全性：数据加密和数据交付前解密，还包括其他如数据完整性和端点鉴别等安全性服务。
### 2.1.4 因特网提供的运输服务

1. TCP服务

   TCP服务模型包括面向连接的服务和可靠的传输服务。

* 面向连接：在传输数据报文前，客户机与服务器程序相互交换控制层控制信息。(三次握手)

* 可靠数据传输服务：无差错、按适当顺序交付发送的数据，没用字节的丢失和冗余。
  
* 拥塞控制协议：当发送端和接收端之间的网络出现拥塞时，该机制会抑制发送过程。（目的是让网络中的用户共享网络宽带）。
  
* SSL 安全套接字层
2. UDP服务

   不提供不必要服务的轻量级传输层协议，进程之间没有连接过程，不可靠并且接收端接受的信息可能是乱序的，无拥塞控制机制。

3. 进程寻址
    为了识别接收进程，需要定义：主机的名称或地址、用来指定目的主机接收进程的标识。主机通过IP地址进行标识，发送程序也必须识别运行在主机上的接收进程（端口号就是服务于此）。

### 2.1.5 应用层协议

**应用层协议定义了运行在不同端系统上的应用程序进程如何相互传递报文**。特别是应用层协议定义了：

* 交换的报文的类型，如请求报文和响应报文

* 各种报文类型的语法，如报文中各个字段及其详细描述

* 字段的语义，即包含在字段中信息的含义

* 进程何时、如何发送报文以及对报文的相应规则

## 2.2 Web和HTTP协议

Web的按需操作：当用户许需要时，就能得到他想要的内容。

### 2.2.1 HTTP概况

HTTP全名**超文本传输协议**，是Web的核心。HTTP协议由客户机程序和服务器程序两部分实现，他们运行在不同的端系统中，通过交换HTTP报文进行会话。

**Web页面**是由对象组成的，对象包括HTML文件、图像文件、Java小程序等等，这些文件可以通过一个URL地址寻址。多数Web页面包含一个**基本HTML文件**，基本HTML文件通过各个对象的URL地址对其进行引用。

**Web浏览器**实现了HTTP的客户机端，**Web服务器**用于储存Web对象，每个对象由URL寻址。流行的Web服务器程序有Apache、Microsoft Internet Information Server。

**HTTP协议使用TCP作为他的支撑运输层协议**。HTTP客户机发起一个与服务器的TCP连接，连接后浏览器和服务器进程就可以通过套接字接口访问TCP。

服务器向客户机发送被请求的文件时，并不存储任何关于该客户机的状态信息，因此HTTP是一种**无状态协议**，并且在整个结构中，Web服务器必须总是打开的，并具有一个固定的地址。

### 2.2.2 非持久连接和持久连接

非持久连接：

* 每个请求/响应对是经过一个单独的TCP连接发送的，为每一个请求的对象建立和维护一个全新的连接。
* 这个过程客户机和服务器都要分配TCP的缓存区和变量，给服务器带来了负担，每一个对象的传输时延都为2个RTT(往返时间)，一个用来建立TCP，另一个用于请求和接收对象。

持久连接：

* 服务器在发送响应后保持该TCP连接打开，在相同的客户机和服务器之间的后续请求和响应报文可以通过相同的连接进行传送
* 在位于同一台服务器的多个Web页面在从该服务器发送给同一个客户机时，可以在单个持久TCP上进行。
* 一般来说若一定时间间隔一个连接仍未被使用，则断开连接。

往返时间（RTT）

### 2.2.3 HTTP报文格式

两种格式：请求报文和响应报文

#### 1. 请求报文

报文由ASCII文本书写，HTTP请求报文的第一行叫做请求行，其后继的行称为首部行。

请求行的三个字段为：

* 方法字段：GET（浏览器请求对象时）、POST、HEAD、PUT、DELETE
* URL字段
* HTTP协议版本字段。

首部行：
* Host: 定义了目标所在的主机
* Connection: close 告诉服务器不希望使用持久连接
* User-agent: 定义用户代理，即浏览器的类型
* Accept-language: 表示用户想得到该对象的指定语言版本，无则使用默认版本（众多可选内容协商首部之一）

实体主体行：
在首部行的空行的后面，使用POST方法时才使用（可以用于用户提交表单，例如向搜索引擎提供搜索关键词），但用表单生成的请求报文不需要使用POST方法（而是GET，将输入数据传送到正确的URL））

#### 2. 响应报文

响应报文包括：初始状态行、首部行、实体主体（报文的主体）

状态行：协议版本、状态码、对应状态信息。

首部行：
* connection: close 表示在报文发送后服务器关闭了这条链接。
* Date: 指示服务器传声并发送该响应报文的日期和时间
* Server: 指示服务器类型
* Last-Modified: 指示最后修改的日期和时间
* Content-Length: 被发送对象的字节数
* Content-Type: 实体主题对象的类型，比如text/html表示HTML文本。

常见的状态码：
* 200 OK 请求成功
* 400 Bad Request 差错代码，服务器无法理解
* 404 Not Found 被请求的文档不在服务器上
* 505 HTTP Version Not Supported 服务器不支持请求报文所使用的HTTP版本协议。
### 2.2.4 用户与服务器交互:cookie

50. cookie: HTTP使用cookie来允许站点识别用户、跟踪用户，以实现用户的限制访问或将指定内容与用户关联起来。cookie可以再无状态的HTTP上建立一个用户会话层。

51. cookie组成：
    * HTTP响应报文中的一个cookie首部行
    * HTTP请求报文中的一个cookie首部行
    * 用户端系统保留一个cookie文件，管理用户浏览器
    * Web站点的后端数据库

### 2.2.5 Web缓存

52. Web缓存也叫代理服务器（proxy server），它是能够代表初始Web服务器来满足HTTP请求的网络实体

    它有自己的储存空间，已保存最近请求过的对象的拷贝。

    它既是服务器，又是客户机。

53. 浏览器请求网页的过程：

    1. 浏览器建立一个到Web缓存器的TCP连接，向Web缓存器中的对象发送一个HTTP请求。
    2. Web缓存器检查是否有本地拷贝，有则用HTTP响应报文向客户机返回该对象
    3. 没有则向初始服务器（请求网页的服务器）打开一个TCP连接，并向其发送HTTP请求，初始服务器响应。
    4. Web接受该对象后，在本地储存一份拷贝，并用HTTP响应报文发给浏览器该对象的拷贝。

54. 部署Web缓存的好处：

    1. 大大减少对客户机请求的响应时间，特别是服务器与初始服务器的带宽远远低于客户机与Web缓存器带宽时。
    2. Web缓存减少了一个内部网与因特网接入链路上的通信量，从整体上大大降低了因特网上的Web流量，从而改善所有应用的性能。

### 2.2.6 条件GET方法

55. 条件GET方法：允许缓存器检查它的对象是否是最新的。请求报文中包含一个`if-modified-since`首部行。由Web缓存向初始服务器发送，初始服务器返回响应报文，状态信息304 Not Modified表示未修改。

## 2.3 文件传输协议:FTP

56. **FTP使用两个并行的*TCP*链接来传输文件**，一个是控制连接，一个是数据连接，前者用于在两个主机之间传输控制信息，后者用于传输实际文件。

57. 带外传送与带内传送：带外传送使用分离的控制连接和数据连接，如FTP和RTSP，而将数据和控制共用一个TCP连接则称带内传送，如HTTP。

58. FTP会话创建

    1. 客户机在21号端口上发起一个用于控制的TCP连接，并通过该控制连接发送用户口令和标识等命令
    2. 服务器接收文件传输命令后，发起一个到客户机的数据连接（客户机20端口）。
    3. 控制连接贯穿对话全过程，但是每一次传输文件都要单独建立一个数据连接。

    FTP是有状态的，整个过程中，监视用户的状态信息。

59. 部分命令与回答：
    1. USER username
    2. PASS password
    3. LIST 请求当前目录的文件列表，该列表在数据链接上传送。
    4. **RETR** filename 检索并请求该文件
    5. STOR filename 向远程主机的当前目录保留此文件

## 2.4 因特网中的电子邮件

60. 电子邮件系统的组成：用户代理，邮件服务器，简单邮件传输协议（SMTP）
61. SMTP使用TCP可靠传输服务，从发送方的邮件服务器向接收方的邮件服务器发送邮件。每个邮件服务器有两个部分：SMTP服务器和SMTP用户机

### 2.4.1 SMTP

62. SMTP邮件收发过程：
    1. A调用A的邮件代理程序并提供B的邮件地址写邮件，让后通过用户代理发送邮件
    2. A的用户代理将报文发送给A的邮件服务器，将报文放在报文发送队列中
    3. 运行在A邮件服务器的SMTP客户极端将创建一个到B的邮件服务器的SMTP服务器的TCP链接
    4. 经过初始SMTP握手之后，B的接收服务器接收该报文，再将邮件放入B的邮箱中。
    5. B方便时调用用户代理阅读邮件。
63. SMTP不使用中间邮件服务器发送邮件；SMTP端口号：25，客户机的一些命令举例：HELO，MAIL FORM，RCPT TO，DATA，QUIT。

### 2.4.2 SMTP与HTTP对比

64. 相同点：都用于传送文件、都是用持久连接。
65. 不同点：
    1. HTTP是一个拉协议，SMTP是一个推协议
    2. SMTP要求报文使用7为ASCII码，对于特殊字符和媒体数据需要进行编码解码，HTTP无此要求
    3. 对于复合媒体文档，HTTP将每个对象封装到自己的响应报文中，而SMTP将所有对象妨碍一个报文中。

### 2.4.3 邮件报文格式与MIME

66. 多用途因特网邮件扩展 MIME 用于处理SMTP发送非ASCII数据文件

    * MIME关键首部：

      * Content-Type和Content-Transfer-Encoding

      * 一个例子：

        ![image-20210707151337282](C:\Users\17727\AppData\Roaming\Typora\typora-user-images\image-20210707151337282.png)

    * SMTP接收服务器接收到发送方发送的邮件后会更新首部，插入一行：Received: from... by...; [time]

### 2.4.4 邮件访问协议

67. 邮件服务器通常是总是保持开启且由多用户所共享的，通常由ISP进行维护
68. 若目的地服务器不可达，发送服务器会每个30分钟重新发送，知道目的服务器运行为止
69. B从邮件服务器上拉取邮件，使用的不是SMTP（推协议），而是专门的邮件访问协议，例如POP3（第三版的邮局协议）、IMAP（因特网邮件访问协议）和HTTP。（而A从邮件代理发送邮件到邮件服务器和邮件服务器之间传输所使用的都是SMTP）
70. POP3：
    1. 三个工作阶段：特许（明文用户名和口令鉴别用户）、事务处理（用户取回报文、用户代理对邮件进行操作）、更新（结束会话）
    2. 服务器使用 +OK -ERR来对用户代理发出的指令来做出应答
    3. 用户代理的命令举例：list retr dele quit
71. IMAP：比POP3更复杂，提供创建文件夹和在文件夹中管理移动邮件的命令等等，IMAP服务器会维护用户状态信息（而POP3不会），同时IMAP允许用户获取报文组件而不是全文。
72. 基于Web的电子邮件：用户代理就是普通的浏览器（同时A通过浏览器发送邮件使用的协议是HTTP而非SMTP）

## 2.5 DNS：因特网的目录服务

### 2.5.1 DNS提供的服务

73. 识别主机的两张方式：主机名和IP地址，前者用以记忆，后者定长、有层次结构
74. 域名解析系统 DNS：进行主机名到IP地址转换的服务。
75. **DNS是一个由分层DNS服务器实现的分布式数据库，也是一个允许主机查询分布式数据库的应用层协议**

76. **DNS运行在UDP之上**，使用53号端口。
77. DNS提供的其他服务：
    1. **主机别名**：通过调用DNS来获得主机别名对应的规范主机名以及其IP地址
    2. **邮件服务器别名**
    3. **负载分配**：用在冗余的服务器之间进行负载分配

### 2.5.2 DNS工作原理

78. 单DNS服务器设计方式的问题：单点故障、通信容量不允许、远距离集中式数据库导致时延、维护困难

79. 分布式、分层次的数据库：

    1. **根DNS服务器**
    2. **顶级域服务器 TLD**
    3. **权威DNS服务器**
    4. *本地DNS服务器*

80. **递归查询和迭代查询**

    * **主机向本地域名服务器的查询一般都是采用递归查询。**所谓递归查询就是：如果主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。
    * **本地域名服务器向根域名服务器的查询的迭代查询。**迭代查询的特点：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地服务器：你下一步应当向哪一个域名服务器进行查询。

    ![image-20210707164126691](C:\Users\17727\AppData\Roaming\Typora\typora-user-images\image-20210707164126691.png)

81. DNS缓存：以**改善时延性能**并**减少因特网上传输的DNS报文数量**。当一个DNS服务器接收一个DNS回答时服务器能将回答中的信息缓存在邮件服务器中，以便下次访问使用。

### 2.5.3 DNS记录和报文

82. DNS资源记录RR：提供了主机到IP的映射，四元组[Name, Value ,Type, TTL]，其中TTL是生存时间，Type可以指示内容是(A)主机+主机IP、还是(NS)域+权威DNS服务器主机名、还是(CNAME)别名+规范主机名、还是(MX)别名+邮件服务器规范主机名
83. DNS报文：查询报文和回答报文
84. ICANN：因特网名字和地址分配机构

## 2.6 P2P应用

85. P2P采用的是对等体系结构而不是客户机/服务器模型。

### 2.6.1 P2P文件分发

### 2.6.2 在P2P区域中搜索信息

### 2.6.3 案例：Skype

