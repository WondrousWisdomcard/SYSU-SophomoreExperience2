# 第五章 链路层和局域网

[toc]

## 5.1 链路层：概述和服务

### 5.1.1 链路层提供的服务

1. 链路层基本概念：链路层协议用来在独立的链路上移动数据报，它定义了在链路端点两端的节点之间交互的分组格式，以及当发送和接受这些分组时这些节点所采用的动作。

2. 链路层的数据单元：帧。当发送和接受帧时，链路层协议所采取的动作包括差错检测、重传、流量控制和随机接入。

3. 链路层协议：**以太网、802.11无线LAN、令牌环和PPP**，很多场合下ATM也被视为链路层协议。
4. 链路层的任务：将上层数据包通过路径中的**单端链路节点到节点地传送**，因此，在不同的路径上可能由不同的链路层协议所承载，并且不同协议提供的服务可能是不同的。
5. **链路层能够提供的服务：成帧、链路接入、可靠交付、流量控制、差错检测、差错纠正、半双工和全双工**（采用全双工传输时，链路两端的节点可以同时传输分组，半双工指一个结点不能同时进行传输和接收）
6. 链路层提供的一些服务（可靠交付、流量控制、差错检测）于网络层所提供的这些服务的不同之处：传输层是在端到端的基础上提供的，而**链路层协议是在节点对相邻节点的基础上提供的**。 
7. 两种类型的网络链路：点对点链路和广播链路，点对点链路是由链路一端的当个发送方和链路另一端的单个接收方组成，例如点对点协议PPP和高级数据链路控制HDLC。**广播链路能够让多个发送和接收节点都连接到相同的、单一的、共享的广播信道上**，例如以太网和无线LAN。

### 5.1.2 链路层在何处实现

8. **链路层的主体部分是在*网络适配器*中实现**的，网络适配器也称为网络接口卡。链路层的控制器的许多功能都是用硬件实现的，现在网络适配器都已经被综合进了主机的主板

## 5.2 差错检测和纠错服务

### 5.2.1 奇偶校验

奇偶校验、二维奇偶校验、前向纠错

### 5.2.2 检验和方法

9. 互联网检验和：将数据的两个节点作为16比特的整数对待并求和，这个和的反码形成了携带在报文段首部的互联网检验和。接收方通过对接受的数据（包括检验和）和和取反码，并且检测其结果是否为全1比特来检验和，若有一位为0，就可以指示出差错。

### 5.2.3 循环冗余检测

## 5.3 多路访问协议

10. 多路访问问题：**如何协调多个发送和接收节点对一个共享广播信道的访问。**
11. 多路访问协议：**节点通过这些协议来规范它们在共享的广播信道上的传输行为**。
12. 多路访问协议所希望具有的特性：
    1. 当只有一个节点要数据要发送时，该节点具有R bps的吞吐量。
    2. 当有M个节点要发送数据时，每个节点（平均）吞吐量为R/M bps。
    3. 协议是分散的，这就是不会某主节点故障而使整个系统崩溃。
    4. 协议是简单的，实现代价不是很高。

### 5.3.1 信道划分协议

13. 三种用于共享信道节点之间用于划分广播信道宽带的技术：时分多路复用（TDM）、频分多路复用（FDM）、码分多址（CDMA）。
14. TDM：将时间划分为时间帧，划分每个时间帧为N个时隙，然后把每个时隙分配给N个结点中的一个。
    * 优点：TDM消除了碰撞，使得每个节点在时间帧内得到了**专用的传输速率**R/N bps。
    * 缺点：节点平均速率被限制在R/N bps。
15. FDM：将R bps信道划分为不同的频段（每个频段具有R/N带宽），并把每个频率分配给N个节点中的一个。 同样避免了碰撞，在N个节点之间公平地划分了带宽，缺点同样是将节点平均速率限制在R/N bps。
16. **CDMA 码分多址**：CDMA为每个节点分配了一种不同的编码，每个节点用它唯一的编码来对它发送的数据进行编码。若经过精心的编码，CMDA能够使得不同的节点同时传输，并且它们各自相应的接收方仍然能正确接收发送方编码后的数据比特。（但是具体怎么编码没有告诉我们，我也不想知道）

### 5.3.2 随机接入协议（重要）

17. 在**随机接入协议**中，一个传输节点总是以信道的全部速率进行发送，当有碰撞时，涉及碰撞的每个节点反复地重发它的帧，直到该帧无碰撞地通过为止。但是当一个节点经受一次碰撞时，他不必立刻重发该帧，相反，它在重发该帧之前等待一个随机时延。
18. 常用的随机接入协议：ALOHA协议和CSMA协议（载波侦听多路协议），然后，**以太网是CSMA协议**。
19. 时隙ALOHA：概率P重传
    * 假设：所有帧由恰好L比特组成，时间被划分为长度为L/R s的时隙，节点只在时隙起点开始传输帧，节点是同步的，**若一个时隙中有碰撞，在时隙结束前能检测到该碰撞事件**。
    * ALOHA操作：当节点有新帧要发送时，需要等待下一个时隙开始并在该时隙传输该帧。**没有碰撞则成功传输，否则该节点以概率P在后续的每个时隙中重传它的帧**，直到传输成功。
    * 优点：网络能够允许不忙碌情况下全速连续传输。高度分散，每个节点检测碰撞并独立决定何时重传（但是同步比较麻烦）。
    * 效率：**假设每个节点试图在每个时隙以概率p传输一帧，假设有N个节点，则一个给定时隙是成功时隙的概率是一个节点传输而其他N-1个节点不传输的概率，它们相互独立**，故传送成功的概率是p(1-p)^(n-1)，因为有N个节点，任意一个节点成功传送的概率是Np(1-p)^(N-1)，当p取1/e（约等于0.37）时，该协议有最大效率1/e。
20. ALOHA：
    * 纯ALOHA中，当一帧首次到达，节点立刻将该帧完整地传输进广播信道，若传输的一个帧与一个或多个传输经受了碰撞，这个节点立即以概率p重传，否则等待一个**帧传输时间**。
    * 效率：采用**帧传输时间作为时间单元**，在任何给定时间，某个节点传输一个帧的概率是p，假设在时刻t_0开始传输，该帧成功传输的前提是在[t_0-1, t_0]内没有节点开始传输，在[t_0, t_0+1]内也没有节点开始传输，否则会发生重叠，因此，给定一个节点传输成功一次的概率是p(1-p)^(2(N-1))，因为有N个节点，任意一个节点成功传送的概率是Np(1-p)^(2(N-1))，当p取1/(2e)，该协议有最大效率1/(2e)。
21. 载波侦听多路访问（CSMA）
    * 载波侦听：Carrier sensing，**在一个节点传输前先听信道，若有别的节点正在发送，则等待一段随机事件。**
    * 碰撞检测：Collision detection，**在一个节点在传输时一直在侦听信道，若检测到另一个节点的干扰就停止传输。**
    * 信道传播时延：信号从一个节点传播到另一个节点所花费的时间，在决定CSMA性能上起着关键作用，时延越长，载波侦听节点不能侦听到网络中另一个节点已经开始传输的机会越大。

### 5.3.3 轮流协议

轮流协议主要包括轮询协议和令牌传递协议

22. 轮询协议：要求一个节点被指定为主节点，**主节点以循环的方式轮询每个节点**，消除了随机接入协议引入的碰撞和空时隙，提高了效率，但引入了轮询时延（通知一个节点它可以传输这个过程所需的时间），主节点必须每次依次轮询每一个节点，不管该节点是否活跃，同时，**一旦主节点故障，整个信道就会出问题。**
23. 令牌传递协议：协议没有主节点，**一个小的称为令牌的特殊目的帧在节点之间以某种固定次序进行交换**。当一个节点收到令牌时，若要发送东西则持有令牌，否则转发给下一个主机。令牌传递是分散的，并由很高效率，但一个节点的故障会引起整个信道的崩溃，一个节点操作失误（忘记释放令牌），可能会导致网路故障。FDDI、**IEEE 802.5是令牌传递协议**。

### 5.3.4 局域网

24. 多路访问协议和很多不同类型的广播信道联系在一起，它们已经用于包括卫星和无线信道中，这些信道的节点在共同的频谱上传输，它们当前用于电缆接入因特网的上行信道中，并广泛适用于局域网（LAN：**一种集中在一个地理区域的计算机网络**，LAN包括基于随机接入的以太网和令牌传递技术）中。
25. 令牌环LAN：LAN的N个节点通过直接链路连接成一个环，令牌环的拓扑定义了令牌传递次序。

## 5.4 链路层编制

### 5.4.1 MAC地址

26. **MAC地址**：我们将链路层地址称为MAC地址，节点的适配器所具有的链路层地址，**MAC地址长度为6字节（48比特）**，六个字节通常用16进制表示法表示，没有两个适配器拥有相同的MAC地址。
27. 当某适配器要向目的适配器发送帧时，发送方将目的适配器的MAC地址插入到该帧中，发送到LAN。若该LAN是一个广播LAN，则该帧会被发送到其他所有适配器，接收方对帧进行检查，若目的MAC与本机一致则提取出封装的数据，否则丢弃该数据报。对于目的地址为所有人，目的MAC地址则填MAC广播地址（FF-FF-FF-FF-FF-FF）

### 5.4.2 地址解析协议 ARP

28. 目的：**在网络层地址和链路层地址之间进行转换**。

29. 发送节点如何根据目的IP确定目的MAC地址：通过ARP协议，发送节点中的ARP模块将取在相同LAN上的任何IP地址作为输入，然后返回相应的MAX=C地址。

30. ARP解析器与DNS解析器的差别：DNS为在因特网中的任何地方的主机解析主机名，而**ARP只为在同一个子网上的节点解析IP地址**。

31. ARP工作原理：每个节点在ARP模块维护一个ARP表，此表包含**IP地址到MAC地址的映射关系**。该表（每一项）包含一个生存周期值，指示从表中删除该映射的时间。当ARP没有目录节点的表项时，发送节点先用ARP来解析地址，构造一个ARP分组，发送出去以询问子网上的所有其他节点，以确定对应于要解析的IP地址的MAC地址。

    当要发送数据到子网以外的节点时，路由器的每个接口都有一个ARP模块和适配器。

32. ARP特性：

    1. **查询ARP报文在广播帧中发送**，而响应ARP报文在一个标准帧中发送。
    2. ARP即插即用，**节点的ARP表是会自动建立的**。

## 5.5 以太网

33. **以太网是一种有线局域网**。
34. 以太网设备：集线器、**交换机**（反映了以太网的发展历程，从总线型到基于集线器的星型结构，到基于交换机的星型结构）。
    * **集线器：一种物理层设备，作用于各比特**而不是帧，集线器负责重新生成到达的比特，放大其能量的强度，再传送出去。然而，若集线器同时从两个不同的接口接收到帧，出现一次碰撞，生成该帧的节点必须重新传输该帧。
    * 交换机：之后再讲。

### 5.5.1 以太网帧结构

35. 以太网帧结构：
    * 数据字段：承载IP数据报
    * 目的MAC地址和源MAC地址
    * 类型字段：允许以太网复用多种网络层协议，例如ARP
    * 循环冗余检测和前同步码，前同步码指以太网中一个以太网帧以8字节的前同步码开始，前7个字节都是10101010，用于唤醒适配器，并且将它们的时钟和发送方的时钟同步。最后一个字节是10101011.
36. 基带传输：**以太网采用基带传输**，许多以太网技术采用曼彻斯特编码（物理层操作），使用原因是发送和接受的适配器之间没有精确的同步。
37. 服务类型：**以太网向网络层提供不可靠的无连接服务。**

### 5.5.2 CSMA/CD: 以太网多路访问协议

38. CSMA/CD机制：**无时隙、载波侦听、碰撞检测、随机重传**。
39. CSMA/CD下适配器要求：当某些其他适配器在传输时进行侦听；当传输时检测碰撞。以太网适配器通过测量传输前和传输中的**电压水平**来执行这两个任务。
40. CSMA/CD工作方式：
    1. 获取上层数据报，封装成帧并放到适配器缓存区。
    2. 如果适配器监听到信道空闲，他开始传输该帧。如果信道忙，他等到侦听不到信号量（加上96比特时间），然后传输该帧。
    3. 传输过程如果监视到了来自其他适配器的信号能量的出现。如果适配器传输了整个帧，而没有检测到其他适配器的能量信号，则完成该帧的传输。
    4. 传输过程如果检测到其他能量信号，终止传输，而代之传输一个48比特的阻塞信号。
    5. 终止后，适配器进入一个指数后退阶段，在该帧经受了一连串的第n次碰撞后，适配器随机地从{0, 1, 2, 3, ... ,2^m-1}中选一个值，其中m = min{n, 10}，然后适配器等待k*512比特时间再回到第2步。

41. CSMA/CD中**阻塞信号的目的**：**确保所有其他传输中的适配器意识到此次碰撞，因为再检测到另一方的信号后，一方如果发送的比特数比较少，无法让另一方感知到，因而要多发这48字节。**

42. 以太网效率：当有大量活跃节点，且每节点有大量的帧要发送时，帧在信道中无碰撞地传输的那部分时间占长期运行时的份额。

    d_prop表示信号能力在任意两个适配器之间传输所需的最大时间，d_trans表示传输一个最大长度的以太网帧的时间，有近似式：`效率 = \frac{1}{1+5d_{prop}/d_{trans}}`

## 5.6 链路层交换机

43. 交换机的任务：**接收入链路层帧并将它们转发到出链路**，交换机输出接口设有缓存。

### 5.6.1 交换机的转发和过滤

44. **过滤：交换机决定一个帧是应该转发到某个接口还是应当将其丢弃。**
45. **转发：决定一个帧应该被导向哪个接口，并把该帧接口移动到这些接口的交换机功能。**
46. 交换机表：交换机的过滤和转发都需要依靠交换机表完成，该表包含LAN上某些节点但不必是全部节点的表项，一个表项包含：节点MAC地址、到达该节点的交换机接口，该项放置在该表中的时间 
47. 交换机工作方式：一个帧来临时，有以下三种情况
    1. **表中没有对应MAC表项，则除原接口外向每一个其他接口转发（广播）**
    2. **表中对应MAC表项对应的接口就是入接口本身，则丢弃该分组（过滤）**
    3. **表中存在对应MAC表项对应的接口且非入接口本身，则往该接口转发（转发）**

### 5.6.2 自学习

48. 交换机是自学习的，能自动、动态地建立交换机表，是即插即用设备（Plug-and-play)，也是双工的，无碰撞。
49. 自学习实现方式：
    1. 交换机表初始为空。
    2. 对于某接口接收到的某个入帧，该交换机在表中储存（储存源地址、该帧接口和时间），交换机以这种方式在表中记录发送节点所在的网段。
    3. 超过老化时间后，删除该交换机表项。

### 5.6.3 链路层交换机的性质

50. 交换机的优点、性质：
    1. 消除碰撞：交换机的最大聚合带宽是所有接口速率之和。
    2. 异质的链路：链路彼此隔离
    3. 管理：提供强化的安全性、易于网络管理、可用于收集统计宽带数据。

### 5.6.4 交换机与路由器的比较

51. 直接差别：**路由器使用网络层IP地址转发，链路层交换机使用链路层MAC地址转发分组**，本质上它们都是储存转发分组交换机。

52. 交换机的优缺点：

    1. 优点：**即插即用**，相对高的分组过滤和转发速率
    2. 缺点：**交换网络的活跃拓扑被限制为一棵生成树，不对网络风暴提供任何保护措施**。大型交换网络要求有大的ARP表。

53. 路由器的优缺点：

    1. 优点：路由器没有生成树结构限制，所以**可以用各种拓扑结构来构建网络**；**对网络风暴提供了防火墙保护**
    2. 缺点：不是即插即用的，路由器和链接到它们的主机需要人为配置IP地址；处理分组的时间长于交换机。
    3. 一般对于小网络，使用交换机就足够了，对于更大的网络，还需要配置路由器，以提供更健壮的流量隔离方式和广播风暴控制。

54. 三种互联网设备比较

    |          | 集线器 | 路由器 | 交换机 |
    | -------- | ------ | ------ | ------ |
    | 流量隔离 | 无     | 有     | 有     |
    | 即插即用 | 有     | 无     | 有     |
    | 优化选路 | 无     | 有     | 无     |
    | 直通交换 | 有     | 无     | 有     |

## 5.7 PPP 点对点协议

55. **PPP是点对点链路的链路层协议**，一条直接连接两个节点的链路。通常作为住宅主机拨号链路所选择的协议，HDLC（高级数据链路控制协议）也是点对点的链路层协议。
56. PPP（建议案）要求：分组成帧、透明、支持多种网络层协议和多种类型的链路、提供差错检测和连接的活性（检测故障）、简单、能够进行网络层地址协商；不要求：差错纠正、流量控制、有序和多点链路。
57. **字节填充技术**：因为PPP标志字段使用特殊比特模式来进行界定帧的开始和结束，在正文中若出现该字段，需要使用字节填充技术来避免错误发生。填充方式是定义一个特殊的转移字节，在与标志字段相同的字节前插入转移字节（此外，转移字节本身在原数据中出现时也需要加上转移字节。

## 5.8 链路虚拟化：网络层作为链路层

这些用作链路虚拟化的协议本身就是分组交换的虚电路网络，有着自己的分组格式和转发行为。我们将链路抽象为信道。

### 5.8.1 异步传输方式 ATM

58. ATM有一套完整的端到端的标准，**它是一种分组交换、虚电路网络体系结构**，支持多种服务模式。

59. ATM特性：

    1. ATM适配层 AAL，类似于因特网运输层，仅出现在ATM网络边缘的设备上。其处理的数据单元成成为PDU，类似于UDP、TCP报文段。

    2. ATM层：ATM核心，定义了ATM信元的结构，类比于IP网络，ATM信元类比于IP数据报。

       在传输信元前，ATM网络必须建立一条虚通道（VC），通过虚通道标识与每条链路联系起来，在创建和删除VC时更新VC转换表。

    3. ATM物理层：ATM协议栈最底层，处理物理媒体电压、比特定时和成帧。

60. 在ATM上传输IP：**将ATM网络用于提供IP设备之间的连通性**，关键步骤：

    1. 入口路由器将ATM视作一种链路层协议，通过ATM ARP决定下一跳物理地址，入口路由器将数据报向下传递到链路层。
    2. 接下来由ATM进行工作：确定通向目的ATM地址的虚通道；将数据报分段为信元，在接收端重新组装。

### 5.8.2 多协议标签交换 MPLS

61. MPLS目标：（改善IP路由器的转发速度）基于固定长度标签和虚电路，在不放弃基于目的IP数据包转发的基础设施前提下，当可能是通过选择性地表示数据报并允许路由器基于固定长度的标签转发数据报，从而增强其功能。
62. MPLS的一些事实：基于标签执行交换而不必考虑分组的IP地址；MPLS可以管理流量，提供了沿多条路由转发分组的能力，也能用于执行MPLS转发路径的快速恢复，例如对链路故障作出反应。

> Done

