# 第八章 计算机网络中的安全

[toc]

## 8.1 网络安全

1. 安全通信所具备的特性：
   1. 机密性（Confidentiality）：仅有发送方和其指定的接收方能够理解报文内容，要求报文在一定程度上进行加密（Encrypted）。
   2. 报文完整性（Message Integrity）：确保通信的内容在传输过程中没有被恶意篡改或意外改动
   3. 端点鉴别（End-point Authentication）：发送方与接收方都应能证实通信过程所涉及的另一方，以确信通信的另一方确实具有他们所声称的身份。
   4. 运行安全性（Operational Security）

## 8.2 密码学原则

2. 密码学相关概念集合：明文、密文、加密算法、解密算法、密钥、对称密钥系统、公开密钥系统。

### 8.2.1 对称密钥密码学

3. 简单的对称密钥策略：凯撒密码、单码替代密码、多码替代密码。

   单码替代密码的三种攻击方式：

   1. 唯密文攻击：统计分析密文字符规律
   2. 已知明文攻击：通过以某种方式获得的密文报文中出现的字词，即可确定相关字符明文与密文的匹配关系
   3. 选择明文攻击：以某种方式让发送方发送一个包含所有字符的串，入侵者根据串的对应关系破解加密方案

4. 对称加密技术两种类型：流密码和块密码。块密码应用于PGP、SSL、IPsec等加密协议中。

5. 块密码：将要加密的报文处理为一块块固定比特的块，块密码通常使用函数模拟随机派列表。流行的块密码包括DES、3DES、AES。

6. 密码块链接和初始向量：**为了抵御攻击者的统计分析破解，在密文中结合某些随机性，使得相同明文块在不同位置产生不同的密文块**。

   一种策略是明文发送一个随机数，随机数与明文块异或后再通过加密算法加密，可保证两个相同的明文块有不一样的密文块。

   为了在利用上述策略的同时节省宽带，使用**密码块链接**（Cipher Block Chaining，CBC）的技术，**其基本思想是紧随第一个报文发送一个随机值，然后让发送方和接收方使用计算的编码块替代后继的随机数。**

   我们也将初始的**随机K比特串**成为**初始向量**（Initialization Vector，IV），**发送方以明文形式发送**。

### 8.2.2 公开密钥加密

7. 公开密钥加密的用途：加密、鉴别和数字签名。

8. 基本思路：公钥（KB+）为所有人可知，私钥(KB-)只有发送者知道。在通讯前，A先取得B的公钥，然后用着一个公钥和一个众所周知的加密算法，加密A要传给B的报文（即A计算KB+(m)），B收到该报文后计算KB-(KB+(m))  = m获得加密报文（然而不同于对称密钥：KB+(KB+(m))  不等于 m）。

   可以理解成：公钥只能用于加密，私钥才能用于解密。

9. 公开密钥加密的问题：
   1. 由于入侵者了解公钥和所使用的加密算法，可以据此发起明文攻击
   2. 由于B的公钥是公开的，任何人都能像B发送一个已加密的报文，但报文的发送人可以伪造。
10. RSA算法：
    1. 原理：$(a mod n)^d mod n = a^d mod n$
    2. 生成RSA公私钥步骤：
       1. 选择两个大的素数p和q
       2. 计算$n = pq, z = (p-1)(q-1)$
       3. 选择小于n的数e，且e与z互为质数
       4. 求一个数d，使得$ed mod z = 1$
       5. (n,e)作为公钥，(n,d)作为私钥
    3. RSA加密步骤：假设A要给B发送一个有整数m表示的比特组合，且m<n，A计算$c = m^e mod n$，c就是m的密文。
    4. RSA解密步骤：对于B收到的报文c，B计算$m = c^d mod n$得到明文。
11. **会话密钥**：RSA通常与对称密钥结合在一起使用，因为RSA很耗时。如果A要向B发送大量数据，首先A选择一个用于加密的数据本身的密钥，这个密钥又称为会话密钥K_s，A通过RSA加密该会话密钥，计算$c = (K_s)^e mod n$，B收到后解密，解密后用改会话密钥进行数据传输。
12. RSA安全性前提：目前没有已知算法可以快速进行一个数的因数分解，给定n无法算出p和q。

## 8.3 报文完整性

13. 数据完整性也称为报文鉴别，包括数字签名和端点鉴别。**报文鉴别包含以下两点内容：1）报文来源正确、2）报文未被篡改**

### 8.3.1 密码散列函数

14. **密码散列函数**在哈希的基础上，要求找到任意两个内容不同的但哈希相同的报文，在计算上是不可能的。
15. 两个目前广泛使用散列算法：
    1. **MD5**散列算法：得到128比特的散列
    2. **SHA-1**散列算法：生成160比特的报文摘要

### 8.3.2 报文鉴别码

16. 鉴别密钥（Authentication Key）：由发送方和接受方共享的比特串。
17. 报文完整性的执行过程：（令鉴别密钥为s）
    1. A生成报文m，以s级联m已生成m+s，并计算H(m+s)，H(m+s)被称为报文鉴别码（Message Authentication Code，MAC）。
    2. A将MAC附加到原报文m上，生成扩展报文(m,H(m+s))，发送给B。
    3. B接收到扩展报文(m,h)，由于知道s，计算出报文鉴别码H(m+s)，若等于h则确认报文完整。

### 8.3.3 数字签名

18. 数字签名（Digtial Signature），需满足签名是可证实的，并且改签名无法被伪造，MAC不能胜任数字签名。

19. 公钥密钥可以用来提供数字签名：为签署一个文档，B使用私钥签署文档（计算KB-(m)）。由于A持有公钥KB+，通过计算KB+(KB-(m))，若得到m，就可说明是B的数字签名。（同时数字签名也能验证完整性）

20. 公钥密钥进行数字签名的顾虑：加密解密代价昂贵。

21. 将散列函数引入数字签名：通过散列函数生成一个报文m固定长度的数据指纹H(m)，B对报文的散列签名而不是对报文本身签名，即计算KB-(H(m))，因为H(m)比较短所以计算会快一些。

22. 数字签名的操作过程：B让初始长度的报文通过一个散列函数，然后用私钥对散列进行数字签名。明文形式的初始报文连同已经数字签名的报文摘要一并发送给A。A将公钥应用于数字签名获得散列结果，然后再把散列函数应用于明文报文已得到第二个散列结果，二者进行比较。

23. 公钥认证：数字签名的一个重要应用，证实一个公钥属于某个特定的实体

24. 认证中心（Certification Authority CA）：完成公钥与特定实体的绑定，其职责就是使得识别和发行的证书合法化，CA有以下作用：

    1. CA证实一个实体的真实身份
    2. 一旦CA验证了某个实体的身份，CA会生成一个把身份和实体公钥绑定起来的证书。


## 8.4 端点鉴别

25. 端点鉴别（End-point Authentication）：**一个实体经过计算机网络向另一个实体证明其身份的过程**。鉴别协议（Authentication Protocol）**通常在两个通讯实体运行其他协议之前完成**。 
26. **不重数**（Nonce）：一个生存协议中只使用一次的数，用于**抵御报文回放攻击**。
27. 不重数的使用过程：
    1. A向B发送报文
    2. **B选择一个不重数发给A（明文）**
    3. **A使用与B共享的对称密钥加密不重数，发回给B**
    4. **B解密报文，若与原不重数相同则鉴别成功**

## 8.5 电子邮件安全

28. 不仅仅在网络层提供安全性服务的原因：
    1. **不能提供用户级别的安全性**
    2. 在**协议栈的较高层部署安全性服务比较容易**

### 8.5.1 安全的电子邮件

29. 使用**会话密钥**保证安全性，**加密数据使用对称密钥**，**使用散列函数和数字签名来提供发送方鉴别和报文完整性**。

### 8.5.2 PGP

30. PGP：一个电子邮件加密方案。安装PGP时，软件为用户生成一个公开密钥对，公钥能被张贴到用户网站上或放在某某台公钥服务器上，私钥则由用户口令及逆行保护。PGP允许用户选择是否对报文进行数字签名、加密报文。
31. PGP的公钥认证机制：由一个可信Web验证。一些PGP用户可以通过保持密钥签署方互相签署对方的密钥，实际上就是用户交换公钥，并用自己的私钥给对方的公钥签名来相互验证密钥。 

## 8.6 TCP连接安全：SSL

32. 安全套接字层（SSL）：被应用于运行在TCP之上的所有应用程序，SSL提供了一个简单的具有套接字的API。采用机密性、数据完整性和客户鉴别来强化TCP。
33. 简单理解SSL：
    1. **三个阶段：握手、密钥导出、数据传输**
    2. 握手：
       1. 握手阶段的任务：B与A创建一条TCP链接、验证A的身份、给A发送主密钥（MS），A和B持有该主密钥生成的SSL会话所需的所有对称密钥。
       2. 握手的完整步骤：
          1. **客户发送它所支持的密码算法的列表，连通一个客户的不重数**
          2. 服务器从列表中选择一个对称算法、公钥算法和MAC算法，把它的选择以及证书和一个服务器不重数返回给客户
          3. 客户验证该证书，提取服务器公钥，生成一个前主密钥（PMS），用服务器的公钥加密该PMS，并将该加密的PMS发送给服务器。
          4. 客户和服务机独立地从PMS和不重数中计算出主密钥，然后生成4个密钥。当选择的对称密码应用于CBC时，则两个初始化向量IV 也从该MS中获得。
          5. 客户机发送所有握手报文的一个MAC
          6. 服务器发送所有握手报文的一个MAC，最后两步用于是握手避免篡改，因为坏人在明文阶段可能遭篡改。
    3. 密钥导出：A、B每人都从MS生成4个密钥
       1. EB：用于B发送到A的数据的**会话加密密钥**
       2. MB：用于B发送到A的数据的**会话MAC密钥**
       3. EA：用于A发送到B的数据的会话加密密钥
       4. MA：用于A发送到B的数据的会话MAC密钥
    4. 数据传输：TCP是一种字节流协议，SSL将数据流分割成记录，每个记录附加一个MAC用于完整性检查，然后加密（记录，MAC）。为了产生这个MAC，B需将数据连通密钥MB放入一个散列函数中，然后B使用会话加密密钥EB进行加密，再进行传输。同时SSL下，B维护一个计数器，开始时为0，每发送一个记录加一，当他计算MAC时，他把该序号包括在MAC的计算当中，所以MAC的散列结构如：（数据，MAC密钥MB，当前序号）
    5. SSL记录格式：[类型，版本，长度，数据，MAC]，前三个字段不加密，后两字段用EB加密。

## 8.7 网络层安全性：IPsec

34. 网络层提供机密性的意义：
    1. 在网络实体对之间具有机密性，发送实体加密它发送给接收实体的所有数据包的载荷（可以装载任何上层协议）。从一个实体向其他实体发送的所有数据报将隐形于任何可能嗅探该网络的第三方。
    2. 潜在性地提供了其他安全性服务，例如
       1. **源鉴别**：使得实体能够核对在数据报的源
       2. **数据完整性**：使得接收实体核能够核对对任何可能的篡改
       3. **防止重放攻击**：检测任何攻击者插入的冗余数据报

### 8.7.1 IPsec和虚拟专用网VPN

35. 虚拟专用网络VPN：跨越在多个地理区域的机构希望拥有自己的IP网络，使得主机和服务器之间能够以安全和机密的方式彼此发送数据，部署单独的物理网络耗资巨大，使用IPsec即可使得流量经公共因特网而不是物理单独网络，但又具备安全性和机密性。

### 8.7.2 AH协议和ESP协议

36. IPsec协议族：**AH（鉴别首部协议）和ESP（封装安全性载荷协议）**是IPsec协议族的两个主要协议。
37. AH（鉴别首部协议 Authentication Header）：提供鉴别和数据完整性的服务，但不提供机密性服务。
38. ESP（封装安全性载荷协议 Encapsulation Security Payload）：提供源鉴别、数据完整性和加密性服务，应用更加广泛。

### 8.7.3 安全关联

39. SA（安全关联 Security Association）：在从源实体从向目的实体发送IPsec数据报之前，源和目的实体创建了一个网络层的**逻辑连接**，并且是单工连接。
40. **路由器维护**有关SA的状态信息：包括安全参数索引SPI、初始接口和目的接口，加密类型，加密密钥和检查完整性的类型和鉴别密钥。一个IPsec实体在安全关联数据库SAD（实体操作系统中的内核数据结构）中储存其所有的SA状态信息。

### 8.7.4 IPsec数据报

41. IPsec分组的两种形式：隧道模式和运输模式。
42. 隧道模式，**将一个普通IPv4数据报转换成一个IPsec数据报**：
    1. 在初始数据报后面附上一个 **ESP尾部字段**
       * ESP尾部字段组成：填充（因为加密的报文必须是块长度的整数倍，故需要填充）、填充长度、下一个首部（的类型）
    2. 使用算法和SA规定的密钥加密上述结果
    3. 在加密结构前加上一个**ESP首部**
       * 首部包含SPI字段和序号字段：SPI用于指示接收实体该数据包属于那个SA，序号用于防止重放攻击
    4. 使用算法和由SA规定的密钥生成上一步结果的鉴别MAC
    5. 将MAC添加到尾部
    6. **最后生成一个普通的IPv4首部形成全新的IP首部，加到载荷之前**。
       * **新首部中的源和目的IP被设置为隧道端点的源和目的路由器接口**，新首部的协议号设置为50（ESP）
43. 安全策略库 SPD：由IPsec实体维护，指示哪些类型的数据报将被IPsec处理，对这些将被处理的数据报应当使用哪个SA。

### 8.7.5 IKE: IPsec中的密钥管理

44. IKE：IPsec使用因特网密钥交换协议来管理SA，该协议让两个实体交换证书、协商鉴别和加密算法，并安全地交换用于在IPsec SA中生成会话密钥的密钥材料。IKE应用两个阶段：

    1. 第一次交换：生成一个双向的IKE SA，两端还未用各自的私钥对报文签字
    2. 第二次交换：在IKE SA信道上发送报文签名，并在此阶段协商加密和鉴别算法。

    因为IKE不涉及任何公钥密码，IKE能够以相对较**低的计算成本**在两个IPsec实体之间**生成大量SA**。

## 8.8 无线LAN安全

### 8.8.1 有线等效保密 WEP

45. WEP是一种协议，为**主机和无线接入点（基站）**之间提供鉴别和数据加密，其假定主机和无线接入点密钥已经达成一致。
46. WEP鉴别的方式：
    1. 无限主机通过接入点请求鉴别
    2. 接入点以128字节的不重数响应鉴别请求
    3. 无限主机用他与接入点共享的密钥加密不重数
    4. 接入点解密主机加密的不重数，经比较相同的鉴别了该主机。
47. WEP特点：相对弱的加密、单一方式执行鉴别、没有密钥分发机制。

### 8.8.2 IEEE 802.11i

48. 802.11i运行的四个阶段：发现、相互鉴别与主密钥MK生成、成对主密钥PMK生成、临时密钥TK生成。

## 8.9 运行安全性：防火墙和入侵检测系统

### 8.9.1 防火墙

34. **防火墙是一种软件和硬件的结合，将内部网络与因特网隔开，只允许一些数据分组通过。**

35. 防火墙的三个目标：
    1. **从内外部流通的流量必须都通过防火墙**
    2. **仅有被授权的流量能够通过**
    3. **防火墙自身免于渗透**
    
36. 防火墙分类：
    1. 传统分组过滤器
    2. 无状态过滤器
    3. 状态过滤器
    4. 应用程序网关
    
37. 传统分组过滤：**独立地检查每个数据报，然后基于管理员特定的规则决定该数据报文当允许通过还是丢弃**，过滤的因素可以包括：IP源或目的地址、协议类型、源或目的端口、TCP标志位、ICMP报文类型等等。

    **路由器使用访问控制列表（允许或者拒绝）来实现防火墙规则**，每个路由器接口都有自己的列表

38. 状态分组过滤：跟踪TCP链接，再做出过滤。

    通过一张连接表来跟踪所有进行中的TCP连接来实现状态跟踪，防火墙通过观察三次握手来判断新连接的开始，当看到FIN分组时能观察该链接的结束，若一定时间内没有看到该链接的任何活动，可以假设该链接结束了。

39. **应用程序网关**：一个应用程序的特定服务器，所有应用程序数据都必须通过它，多个应用程序网关可以在同一主机上运行，但是每一个网关都有自己的进程的单独服务器。

    一般与分组过滤结合在一起使用，例如路由器过滤器堵塞所有Telnet连接，但该应用程序网关发起的除外。

    缺陷：每个应用都需要不同的网关；因为所有的数据都由网关转发，付出的性能负担较重。

### 8.9.2 入侵检测系统

40. 深度分组检查：**查看首部以外的部分，查看分组所携带的实际应用数据**。
41. IDS和IPS：前者为入侵检测系统，当观察到潜在恶意流量时产生警告；后者为**入侵防止系统**，滤除可疑流量的设备。往往需要多个IDS传感器和一个中心IDS处理器。IDS有基于特征的系统和基于异常的系统。
42. 基于特征的IDS：嗅探通过它的每一个分组，将嗅探分组与**攻击特征数据库**中的特这个进行比较，若相匹配则发出警告。其限制是：无法判定出对未记录的新攻击特征；匹配后可能会误判。
43. 基于异常的IDS：IDS根据流过的流量生成一个流量概况文件，然后寻找在**统计上不寻常的分组流**，特点是不依赖于以前的指示，但区分正常异常流量是一件富有挑战性的问题。

> Done!

